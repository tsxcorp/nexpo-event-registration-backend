<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Widget Sample - Fixed Implementation</title>
    <style>
        body {
            font-family: Arial, sans-serif;
            max-width: 1200px;
            margin: 0 auto;
            padding: 20px;
            background: #f5f5f5;
        }
        .container {
            background: white;
            padding: 30px;
            border-radius: 10px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
            margin-bottom: 20px;
        }
        .status-bar {
            background: #fff3cd;
            padding: 15px;
            border-radius: 5px;
            margin-bottom: 20px;
            border-left: 4px solid #ffc107;
        }
        .connection-status {
            font-weight: bold;
            padding: 8px 15px;
            border-radius: 20px;
            display: inline-block;
            margin: 5px;
        }
        .status-connected { background: #d4edda; color: #155724; }
        .status-disconnected { background: #fff3cd; color: #856404; }
        .status-error { background: #f8d7da; color: #721c24; }
        .status-failed { background: #f8d7da; color: #721c24; }
        .logs {
            background: #f8f9fa;
            border: 1px solid #dee2e6;
            border-radius: 5px;
            padding: 15px;
            max-height: 400px;
            overflow-y: auto;
            font-family: monospace;
            font-size: 12px;
            margin: 20px 0;
        }
        .btn {
            background: #007bff;
            color: white;
            border: none;
            padding: 10px 20px;
            border-radius: 5px;
            cursor: pointer;
            margin: 5px;
        }
        .btn:hover { background: #0056b3; }
        .btn:disabled { background: #6c757d; cursor: not-allowed; }
        .input-group {
            margin: 15px 0;
        }
        .input-group label {
            display: inline-block;
            width: 120px;
            font-weight: bold;
        }
        .input-group input {
            padding: 8px;
            border: 1px solid #ccc;
            border-radius: 4px;
            width: 300px;
        }
        .visitor-table {
            width: 100%;
            border-collapse: collapse;
            margin: 20px 0;
        }
        .visitor-table th, .visitor-table td {
            border: 1px solid #ddd;
            padding: 12px;
            text-align: left;
        }
        .visitor-table th {
            background: #f8f9fa;
            font-weight: bold;
        }
        .visitor-table tr:nth-child(even) {
            background: #f8f9fa;
        }
    </style>
</head>
<body>
    <div class="container">
        <h1>üîß Widget Sample - Fixed Implementation</h1>
        <p>ƒê√¢y l√† example widget s·ª≠ d·ª•ng c√°c fix ƒë·ªÉ k·∫øt n·ªëi backend m·ªôt c√°ch ·ªïn ƒë·ªãnh.</p>
        
        <div class="status-bar">
            <strong>üîå Connection Status:</strong>
            <span id="connection-status" class="connection-status status-disconnected">üü° Initializing...</span>
            <span id="backend-health" class="connection-status status-disconnected">üè• Checking Health...</span>
        </div>
        
        <div class="input-group">
            <label>Event ID:</label>
            <input type="text" id="eventId" value="4433256000013114003" placeholder="Enter Event ID">
            <button class="btn" onclick="initializeWithEventId()">Initialize Widget</button>
        </div>
        
        <div class="input-group">
            <button class="btn" onclick="testBackendHealth()">Test Backend Health</button>
            <button class="btn" onclick="testWebSocketConnection()">Test WebSocket</button>
            <button class="btn" onclick="loadVisitorsTest()">Load Visitors</button>
            <button class="btn" onclick="clearLogs()">Clear Logs</button>
        </div>
        
        <div id="logs" class="logs">
            <div>üöÄ Widget sample loaded. Click "Initialize Widget" to start...</div>
        </div>
        
        <div id="visitor-data" style="display: none;">
            <h3>üìä Visitor Data</h3>
            <div id="visitor-stats">
                <p><strong>Total Visitors:</strong> <span id="visitor-count">0</span></p>
                <p><strong>Last Updated:</strong> <span id="last-updated">-</span></p>
            </div>
            <table class="visitor-table" id="visitor-table">
                <thead>
                    <tr>
                        <th>ID</th>
                        <th>Name</th>
                        <th>Email</th>
                        <th>Status</th>
                        <th>Check-in</th>
                    </tr>
                </thead>
                <tbody id="visitor-tbody">
                </tbody>
            </table>
        </div>
    </div>

    <!-- Load the widget fix -->
    <script src="/widget-fix.js"></script>
    
    <script>
        // Global variables
        let currentEventId = null;
        let visitorsData = [];
        
        // Utility functions
        function log(message, type = 'info') {
            const logs = document.getElementById('logs');
            const timestamp = new Date().toLocaleTimeString();
            const icons = {
                'info': '‚ÑπÔ∏è',
                'success': '‚úÖ',
                'error': '‚ùå',
                'warning': '‚ö†Ô∏è'
            };
            
            const icon = icons[type] || '‚ÑπÔ∏è';
            logs.innerHTML += `<div>[${timestamp}] ${icon} ${message}</div>`;
            logs.scrollTop = logs.scrollHeight;
        }
        
        function clearLogs() {
            document.getElementById('logs').innerHTML = '';
        }
        
        function updateBackendHealthStatus(isHealthy) {
            const healthEl = document.getElementById('backend-health');
            if (isHealthy) {
                healthEl.textContent = 'üü¢ Backend Healthy';
                healthEl.className = 'connection-status status-connected';
            } else {
                healthEl.textContent = 'üî¥ Backend Unhealthy';
                healthEl.className = 'connection-status status-error';
            }
        }
        
        // Test functions
        async function testBackendHealth() {
            log('üè• Testing backend health...');
            try {
                const isHealthy = await WidgetFix.checkBackendHealth();
                if (isHealthy) {
                    log('‚úÖ Backend health check passed!', 'success');
                    updateBackendHealthStatus(true);
                } else {
                    log('‚ö†Ô∏è Backend health check failed!', 'warning');
                    updateBackendHealthStatus(false);
                }
            } catch (error) {
                log(`‚ùå Backend health check error: ${error.message}`, 'error');
                updateBackendHealthStatus(false);
            }
        }
        
        async function testWebSocketConnection() {
            log('üîå Testing WebSocket connection...');
            try {
                const eventId = document.getElementById('eventId').value || '4433256000013114003';
                await WidgetFix.setupRealTimeFeatures(eventId);
                log('‚úÖ WebSocket connection test completed!', 'success');
            } catch (error) {
                log(`‚ùå WebSocket connection error: ${error.message}`, 'error');
            }
        }
        
        async function loadVisitorsTest() {
            log('üìä Testing visitor data loading...');
            try {
                const eventId = document.getElementById('eventId').value || '4433256000013114003';
                
                // Use the fixed API request function
                const response = await WidgetFix.makeApiRequest(`/api/events/${eventId}`);
                log(`‚úÖ Event data loaded successfully!`, 'success');
                log(`Event: ${response.event?.name || 'Unknown Event'}`, 'info');
                
                // Try to load visitors (might fail if endpoint doesn't exist, but that's ok)
                try {
                    const visitors = await WidgetFix.loadVisitorsWithRetry(eventId, 1);
                    displayVisitors(visitors);
                } catch (visitorError) {
                    log(`‚ÑπÔ∏è Visitor loading not available: ${visitorError.message}`, 'info');
                }
                
            } catch (error) {
                log(`‚ùå Data loading error: ${error.message}`, 'error');
            }
        }
        
        async function initializeWithEventId() {
            const eventId = document.getElementById('eventId').value;
            if (!eventId) {
                log('‚ùå Please enter an Event ID', 'error');
                return;
            }
            
            currentEventId = eventId;
            log(`üöÄ Initializing widget for event: ${eventId}`);
            
            try {
                // Test backend health first
                await testBackendHealth();
                
                // Setup real-time features
                await testWebSocketConnection();
                
                // Load initial data
                await loadVisitorsTest();
                
                log('‚úÖ Widget initialization completed!', 'success');
                
            } catch (error) {
                log(`‚ùå Widget initialization failed: ${error.message}`, 'error');
            }
        }
        
        function displayVisitors(visitors) {
            log(`üìä Displaying ${visitors.length} visitors`, 'info');
            
            const visitorData = document.getElementById('visitor-data');
            const visitorCount = document.getElementById('visitor-count');
            const lastUpdated = document.getElementById('last-updated');
            const tbody = document.getElementById('visitor-tbody');
            
            visitorCount.textContent = visitors.length;
            lastUpdated.textContent = new Date().toLocaleString();
            
            // Clear existing rows
            tbody.innerHTML = '';
            
            // Add visitor rows (limit to first 10 for demo)
            visitors.slice(0, 10).forEach(visitor => {
                const row = tbody.insertRow();
                row.innerHTML = `
                    <td>${visitor.id || visitor.ID || 'N/A'}</td>
                    <td>${visitor.full_name || visitor.Full_Name || 'N/A'}</td>
                    <td>${visitor.email || visitor.Email || 'N/A'}</td>
                    <td>${visitor.status || visitor.Status || 'N/A'}</td>
                    <td>${visitor.check_in_status || visitor.Check_In_Status || 'N/A'}</td>
                `;
            });
            
            visitorData.style.display = 'block';
        }
        
        // Handle real-time updates
        function handleRealTimeUpdate(data) {
            log(`üì• Real-time update received: ${data.type}`, 'info');
            if (data.registrations) {
                displayVisitors(data.registrations);
            }
        }
        
        function handleCheckInUpdate(data) {
            log(`üé´ Check-in update: ${data.registration?.Full_Name || 'Unknown'} checked in`, 'success');
        }
        
        // Override the connection status update function
        window.updateConnectionStatus = function(status) {
            const statusEl = document.getElementById('connection-status');
            const statusMap = {
                'connected': { text: 'üü¢ Connected', class: 'status-connected' },
                'disconnected': { text: 'üü° Disconnected', class: 'status-disconnected' },
                'error': { text: 'üî¥ Connection Error', class: 'status-error' },
                'failed': { text: 'üî¥ Connection Failed', class: 'status-failed' }
            };
            
            const statusInfo = statusMap[status] || { text: '‚ö™ Unknown', class: 'status-unknown' };
            statusEl.textContent = statusInfo.text;
            statusEl.className = `connection-status ${statusInfo.class}`;
            
            log(`üîå Connection status: ${statusInfo.text}`, status === 'connected' ? 'success' : 'warning');
        };
        
        // Override real-time handlers
        window.handleRealTimeUpdate = handleRealTimeUpdate;
        window.handleCheckInUpdate = handleCheckInUpdate;
        
        // Initialize on page load
        document.addEventListener('DOMContentLoaded', function() {
            log('üìÑ Widget sample page loaded', 'info');
            log('üîß Widget fix library loaded', 'success');
            testBackendHealth();
        });
    </script>
</body>
</html>
