<!DOCTYPE html>
<html lang="vi">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Nexpo Real-time Demo Client</title>
    <style>
        body { font-family: Arial, sans-serif; margin: 20px; background: #f5f5f5; }
        .container { max-width: 1200px; margin: 0 auto; }
        .panel { background: white; padding: 20px; margin: 10px 0; border-radius: 8px; box-shadow: 0 2px 4px rgba(0,0,0,0.1); }
        .status { padding: 10px; border-radius: 4px; margin: 10px 0; }
        .status.connected { background: #d4edda; color: #155724; }
        .status.disconnected { background: #f8d7da; color: #721c24; }
        .log { max-height: 300px; overflow-y: auto; background: #2d3748; color: #e2e8f0; padding: 15px; border-radius: 4px; font-family: monospace; font-size: 14px; }
        .controls { margin: 10px 0; }
        .controls button { padding: 10px 15px; margin: 5px; border: none; border-radius: 4px; cursor: pointer; }
        .controls button.primary { background: #4f46e5; color: white; }
        .controls button.secondary { background: #6b7280; color: white; }
        .controls input, .controls select { padding: 8px; margin: 5px; border: 1px solid #d1d5db; border-radius: 4px; }
        .grid { display: grid; grid-template-columns: 1fr 1fr; gap: 20px; }
        @media (max-width: 768px) { .grid { grid-template-columns: 1fr; } }
    </style>
    <script src="https://cdn.socket.io/4.7.2/socket.io.min.js"></script>
</head>
<body>
    <div class="container">
        <h1>üöÄ Nexpo Real-time Demo Client</h1>
        
        <div class="panel">
            <h2>üìä Connection Status</h2>
            <div id="status" class="status disconnected">Disconnected</div>
            <div class="controls">
                <button id="connectBtn" class="primary">Connect</button>
                <button id="disconnectBtn" class="secondary">Disconnect</button>
                <span>Server: <input type="text" id="serverUrl" value="http://localhost:3000" /></span>
            </div>
        </div>

        <div class="grid">
            <div class="panel">
                <h2>üè† Room Management</h2>
                <div class="controls">
                    <input type="text" id="eventIdInput" placeholder="Event ID (optional)" />
                    <button id="joinEventBtn" class="primary">Join Event Room</button>
                </div>
                <div class="controls">
                    <select id="reportSelect">
                        <option value="Registrations">Registrations</option>
                        <option value="Events">Events</option>
                        <option value="Visitors">Visitors</option>
                    </select>
                    <button id="subscribeReportBtn" class="primary">Subscribe Report</button>
                </div>
                <div class="controls">
                    <input type="text" id="customRoomInput" placeholder="Custom room name" />
                    <button id="joinCustomBtn" class="primary">Join Custom Room</button>
                </div>
            </div>

            <div class="panel">
                <h2>üß™ Test Actions</h2>
                <div class="controls">
                    <input type="text" id="testRoomInput" placeholder="Room to test" value="report_Registrations" />
                    <button id="sendTestBtn" class="secondary">Send Test Message</button>
                </div>
                <div class="controls">
                    <input type="text" id="regIdInput" placeholder="Registration ID" value="4433256000013272115" />
                    <input type="text" id="nameInput" placeholder="Full Name" value="Test User" />
                    <button id="simulateCheckinBtn" class="secondary">Simulate Check-in</button>
                </div>
                <div class="controls">
                    <button id="refreshDataBtn" class="secondary">Force Refresh Data</button>
                </div>
            </div>
        </div>

        <div class="panel">
            <h2>üìù Real-time Log</h2>
            <div class="controls">
                <button id="clearLogBtn" class="secondary">Clear Log</button>
            </div>
            <div id="log" class="log"></div>
        </div>
    </div>

    <script>
        let socket = null;
        
        const elements = {
            status: document.getElementById('status'),
            connectBtn: document.getElementById('connectBtn'),
            disconnectBtn: document.getElementById('disconnectBtn'),
            serverUrl: document.getElementById('serverUrl'),
            log: document.getElementById('log'),
            clearLogBtn: document.getElementById('clearLogBtn'),
            
            // Room management
            eventIdInput: document.getElementById('eventIdInput'),
            joinEventBtn: document.getElementById('joinEventBtn'),
            reportSelect: document.getElementById('reportSelect'),
            subscribeReportBtn: document.getElementById('subscribeReportBtn'),
            customRoomInput: document.getElementById('customRoomInput'),
            joinCustomBtn: document.getElementById('joinCustomBtn'),
            
            // Test actions
            testRoomInput: document.getElementById('testRoomInput'),
            sendTestBtn: document.getElementById('sendTestBtn'),
            regIdInput: document.getElementById('regIdInput'),
            nameInput: document.getElementById('nameInput'),
            simulateCheckinBtn: document.getElementById('simulateCheckinBtn'),
            refreshDataBtn: document.getElementById('refreshDataBtn')
        };

        function log(message, type = 'info') {
            const timestamp = new Date().toLocaleTimeString();
            const colors = {
                info: '#e2e8f0',
                success: '#68d391',
                warning: '#fbb726',
                error: '#fc8181',
                data: '#63b3ed'
            };
            
            elements.log.innerHTML += `<div style="color: ${colors[type]};">[${timestamp}] ${message}</div>`;
            elements.log.scrollTop = elements.log.scrollHeight;
        }

        function updateStatus(connected) {
            elements.status.textContent = connected ? 'Connected ‚úÖ' : 'Disconnected ‚ùå';
            elements.status.className = `status ${connected ? 'connected' : 'disconnected'}`;
            elements.connectBtn.disabled = connected;
            elements.disconnectBtn.disabled = !connected;
        }

        function connect() {
            const serverUrl = elements.serverUrl.value;
            log(`üîå Connecting to ${serverUrl}...`, 'info');
            
            socket = io(serverUrl, {
                transports: ['websocket', 'polling']
            });

            socket.on('connect', () => {
                log(`‚úÖ Connected with ID: ${socket.id}`, 'success');
                updateStatus(true);
            });

            socket.on('disconnect', (reason) => {
                log(`‚ùå Disconnected: ${reason}`, 'error');
                updateStatus(false);
            });

            socket.on('connected', (data) => {
                log(`üéâ Welcome message: ${JSON.stringify(data)}`, 'success');
            });

            // Room events
            socket.on('joined_event', (data) => {
                log(`üè† Joined event room: ${JSON.stringify(data)}`, 'success');
            });

            socket.on('subscribed_report', (data) => {
                log(`üìä Subscribed to report: ${JSON.stringify(data)}`, 'success');
            });

            socket.on('joined_room', (data) => {
                log(`üè† Joined custom room: ${JSON.stringify(data)}`, 'success');
            });

            // Real-time data events
            socket.on('registration_data', (data) => {
                log(`üìã Registration Data: ${data.count} records, Type: ${data.type}`, 'data');
                log(`   Event: ${data.event_id}, Updated: ${data.last_updated}`, 'data');
            });

            socket.on('registration_update', (data) => {
                log(`üìù Registration Update: ${data.type}, Count: ${data.count}`, 'data');
            });

            socket.on('checkin_update', (data) => {
                log(`‚úÖ Check-in Update: ${data.registration.Full_Name} -> ${data.new_status}`, 'success');
            });

            socket.on('checkin_notification', (data) => {
                log(`üéâ ${data.message}`, 'success');
            });

            socket.on('event_update', (data) => {
                log(`üìÖ Event Update: ${data.type} for event ${data.event_id}`, 'data');
            });

            socket.on('zoho_update', (data) => {
                log(`üîÑ Zoho Update: ${data.type} in ${data.report}`, 'data');
            });

            socket.on('test_message', (data) => {
                log(`üß™ Test Message: ${JSON.stringify(data)}`, 'warning');
            });

            socket.on('error', (error) => {
                log(`‚ùå Socket Error: ${error}`, 'error');
            });
        }

        function disconnect() {
            if (socket) {
                socket.disconnect();
                socket = null;
            }
        }

        // Event listeners
        elements.connectBtn.addEventListener('click', connect);
        elements.disconnectBtn.addEventListener('click', disconnect);
        elements.clearLogBtn.addEventListener('click', () => {
            elements.log.innerHTML = '';
        });

        elements.joinEventBtn.addEventListener('click', () => {
            const eventId = elements.eventIdInput.value.trim();
            if (socket && eventId) {
                socket.emit('join_event', eventId);
                log(`üì° Joining event room: ${eventId}`, 'info');
            }
        });

        elements.subscribeReportBtn.addEventListener('click', () => {
            const report = elements.reportSelect.value;
            if (socket && report) {
                socket.emit('subscribe_report', report);
                log(`üì° Subscribing to report: ${report}`, 'info');
            }
        });

        elements.joinCustomBtn.addEventListener('click', () => {
            const room = elements.customRoomInput.value.trim();
            if (socket && room) {
                socket.emit('join_room', room);
                log(`üì° Joining custom room: ${room}`, 'info');
            }
        });

        elements.sendTestBtn.addEventListener('click', async () => {
            const room = elements.testRoomInput.value.trim();
            if (!room) return;
            
            try {
                const response = await fetch('/api/realtime/push/test', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        room: room,
                        event: 'test_message',
                        data: { message: 'Hello from demo client!', timestamp: new Date().toISOString() }
                    })
                });
                const result = await response.json();
                log(`üì§ Test message sent to ${room}: ${result.delivered ? 'delivered' : 'no clients'}`, 'info');
            } catch (error) {
                log(`‚ùå Failed to send test message: ${error.message}`, 'error');
            }
        });

        elements.simulateCheckinBtn.addEventListener('click', async () => {
            const regId = elements.regIdInput.value.trim();
            const name = elements.nameInput.value.trim();
            if (!regId || !name) return;
            
            try {
                const response = await fetch('/api/realtime/checkin/simulate', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        registration_id: regId,
                        event_id: elements.eventIdInput.value.trim() || '4433256000012557772',
                        full_name: name,
                        status: true
                    })
                });
                const result = await response.json();
                log(`üì§ Check-in simulated for ${name}`, 'info');
            } catch (error) {
                log(`‚ùå Failed to simulate check-in: ${error.message}`, 'error');
            }
        });

        elements.refreshDataBtn.addEventListener('click', async () => {
            try {
                const response = await fetch('/api/realtime/registrations/refresh', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        event_id: elements.eventIdInput.value.trim(),
                        clear_cache: true
                    })
                });
                const result = await response.json();
                log(`üì§ Data refresh triggered: ${result.count} records`, 'info');
            } catch (error) {
                log(`‚ùå Failed to refresh data: ${error.message}`, 'error');
            }
        });

        // Initialize
        updateStatus(false);
        log('üöÄ Demo client loaded. Click Connect to start.', 'info');
    </script>
</body>
</html>
